{% extends "base.html" %}
{% block content %}
    <div class="container py-5">
        <div class="row align-items-center pt-4">
            <div class="col-lg-6">
                <h3 class="pre-title text-secondary">{{ g.i18n.home_h3 }} ...</h3>
                <h1 class="page-header mb-3 fw-semibold lh-1">{{ g.i18n.home_h1 }}</h1>
                <h2 class="lead mb-4 after-title m-0">{{ g.i18n.home_h2 }}</h2>
            </div>
            <div class="col-lg-6 mx-auto">
                <div class="highlight p-3 border rounded-2">
                    <form id="websiteForm" action="{{ request.path }}" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="website" class="form-label">{{ g.i18n.label_website }}</label>
                            <input type="url" class="form-control py-3" id="website" name="website" placeholder="https://pixspeed.com" autofocus>
                        </div>
                        <div id="websiteHelp" class="form-text mb-3">
                            {{ g.i18n.placeholder_website }} <a href="{% url "terms" %}">{{ g.i18n.terms_of_service }}</a> | <a href="{% url "privacy" %}">{{ g.i18n.privacy_policy }}</a>
                        </div>
                        <button type="submit" class="btn btn-lg bd-btn-lg btn-bd-primary d-flex align-items-center justify-content-center fw-semibold w-100" id="submitButton">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            {{ g.i18n.submit }}
                        </button>
                        <div class="mt-2 text-center small">** {{ g.i18n.images_deleted }}</div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="container pt-3">
        <div id="listImages"></div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        (function () {
            "use strict";
            $(document).ready(
                function () {
                    var container = $(".page-container");

                    container.on("submit", "#websiteForm", onSubmitWebsiteForm);
                    container.on("click", "#processImages", onProcessImages);
                    container.on("click", ".remove-item", onRemoveItem);

                    function onRemoveItem(e) {
                        e.preventDefault();
                        $(this).closest("[data-url]").remove();

                        if (container.find("#listImages div[data-url]").length === 0) {
                            container.find("#listImages").html("");
                        }
                    }

                    function onProcessImages() {
                        container.find("#processImages").remove();
                        $('html, body').animate({
                            scrollTop: $("#listImages").offset().top
                        }, 500);

                        var images = $(".images-found div[data-url]");
                        processImagesSequentially(images);
                    }

                    function processImagesSequentially(images) {
                        if (images.length === 0) {
                            console.log("All images have been processed.");
                            return;
                        }

                        var currentImage = images.first();
                        var imageUrl = currentImage.data("url");
                        var resultDiv = currentImage.find(".result");

                        resultDiv.html(`<div class="spinner-border text-primary" role="status"> <span class="sr-only d-none">{{ g.i18n.loading }}...</span></div>`);

                        $.ajax({
                            url: "{{ g.api_domain }}/url",
                            type: "POST",
                            data: {url: imageUrl},
                            success: function (response) {
                                resultDiv.html(`<div class="text-center"><div class="fw-bold">-${response.size_reduction}%</div><div class="small">${response.optimized_size}kb</div></div><a class="btn btn-sm btn-success ms-2" href="${response.url}">{{ g.i18n.download }}</a>`);
                                currentImage.removeAttr("data-url");

                                $.ajax({
                                    url: "{% url "api-counter" %}",
                                    type: "POST",
                                    headers: {
                                        "X-CSRFToken": window.csrf_token
                                    },
                                });

                                processImagesSequentially(images.slice(1));
                            },
                            error: function () {
                                resultDiv.html(`<span class="text-danger">{{ g.i18n.error }}</span>`);
                                currentImage.removeAttr("data-url");

                                processImagesSequentially(images.slice(1));
                            }
                        });
                    }

                    function onSubmitWebsiteForm(e) {
                        e.preventDefault();
                        var target = $(this);
                        var submitButton = target.find("#submitButton");

                        submitButton.prop("disabled", true);
                        submitButton.find(".spinner-border").removeClass("d-none");

                        $.ajax({
                            url: "{% url 'web-extractor' %}",
                            type: "POST",
                            data: $(this).serialize(),
                            success: function (response) {
                                container.find("#listImages").html(response.html);
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                alert("Error: " + textStatus + ": " + errorThrown);
                            },
                            complete: function () {
                                submitButton.prop("disabled", false);
                                submitButton.find(".spinner-border").addClass("d-none");
                            }
                        });
                    }
                }
            );
        }());
    </script>
{% endblock %}