{% extends "base.html" %}
{% block schema %}
    <script type="application/ld+json">
        {
          "@context": "https://schema.org",
          "@type": "WebPage",
          "name": "{{ g.i18n.home_title }}",
          "url": "https://pixspeed.com",
          "description": "{{ g.i18n.home_meta_description }}",
          "inLanguage": "{{ g.lang.iso }}",
          "breadcrumb": {
            "@type": "BreadcrumbList",
            "itemListElement": [
              {
                "@type": "ListItem",
                "position": 1,
                "name": "Home",
                "item": "https://pixspeed.com"
              },
              {
                "@type": "ListItem",
                "position": 2,
                "name": "{{ g.i18n.how_it_works_schema_title_name }}",
                "item": "https://pixspeed.com/how-it-works/"
              },
              {
                "@type": "ListItem",
                "position": 3,
                "name": "{{ g.i18n.contact }}",
                "item": "https://pixspeed.com/contact/"
              }
            ]
          },
          "mainEntity": {
            "@type": "WebApplication",
            "name": "PixSpeed",
            "applicationCategory": "Image Optimization",
            "operatingSystem": "All",
            "offers": {
              "@type": "Offer",
              "price": "0",
              "priceCurrency": "USD",
              "description": "{{ g.i18n.free_optimization }}",
              "url": "https://pixspeed.com"
            },
            "featureList": [
              "{{ g.i18n.feature_1 }}",
              "{{ g.i18n.feature_2 }}",
              "{{ g.i18n.feature_3 }}",
              "{{ g.i18n.feature_4 }}"
            ]
          },
          "publisher": {
            "@type": "Organization",
            "name": "PixSpeed",
            "url": "https://pixspeed.com",
            "logo": {
              "@type": "ImageObject",
              "url": "https://pixspeed.com/static/favicon.png"
            }
          }
        }
    </script>
{% endblock %}
{% block content %}
    <div class="bg-melon-light border-bottom border-5 border-black">
        <div class="container py-sm-5 py-3">
            <div class="row align-items-center pt-sm-4 pt-0">
                <div class="col-lg-6">
                    <h3 class="pre-title text-secondary">{{ g.i18n.home_h3 }} ...</h3>
                    <h1 class="page-header mb-3 fw-bold lh-1">{{ g.i18n.home_h1 }}</h1>
                    <h2 class="lead mb-4 after-title m-0">{{ g.i18n.home_h2 }}</h2>
                </div>
                <div class="col-lg-6 mx-auto">
                    <div class="highlight p-3 border rounded-2">
                        <form id="websiteForm" action="{{ request.path }}" method="post">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="website" class="form-label fw-bold m-0">{{ g.i18n.label_website }}</label>
                                <div class="form-text">{{ g.i18n.input_url_disclaimer }}</div>
                                <input type="url" class="form-control py-3" id="website" name="website" placeholder="https://pixspeed.com" autofocus required>
                            </div>
                            <div id="websiteHelp" class="form-text mb-3">{{ g.i18n.placeholder_website }}</div>
                            <button type="submit" class="btn btn-lg bd-btn-lg btn-primary d-flex align-items-center justify-content-center fw-semibold w-100" id="submitButton">
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                {{ g.i18n.submit }}
                            </button>
                            <div class="mt-2 text-center small">** {{ g.i18n.images_deleted }}</div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div id="listImages"></div>
        </div>
    </div>
    <div class="border-bottom border-5 border-black bg-white">
        <div class="container py-5">
            <div class="row">
                <div class="col-lg-6">
                    <div class="position-sticky" style="top: 50px">
                        <h2 class="page-header mb-3 fw-semibold lh-1">{{ g.i18n.how_it_works }}</h2>
                        <p>{{ g.i18n.how_it_works_subtitle }}</p>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="bsb-timeline-1 pt-5 pt-xl-8 ms-2">
                        <ul class="timeline">
                            <li class="timeline-item">
                                <div class="timeline-body">
                                    <div class="timeline-content">
                                        <div class="card border-0">
                                            <div class="card-body p-0">
                                                <h5 class="card-subtitle mb-1 fw-bold">1: {{ g.i18n.upload_your_images }}</h5>
                                                <p class="card-text m-0">{{ g.i18n.upload_your_images_description }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-body">
                                    <div class="timeline-content">
                                        <div class="card border-0">
                                            <div class="card-body p-0">
                                                <h5 class="card-subtitle mb-1 fw-bold">2: {{ g.i18n.automated_optimization }}</h5>
                                                <p class="card-text m-0">{{ g.i18n.automated_optimization_description }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-body">
                                    <div class="timeline-content">
                                        <div class="card border-0">
                                            <div class="card-body p-0">
                                                <h5 class="card-subtitle mb-1 fw-bold">3: {{ g.i18n.download_optimized_images }}</h5>
                                                <p class="card-text m-0">{{ g.i18n.download_optimized_images_description }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li class="timeline-item">
                                <div class="timeline-body">
                                    <div class="timeline-content">
                                        <div class="card border-0">
                                            <div class="card-body p-0">
                                                <h5 class="card-subtitle mb-1 fw-bold">4: {{ g.i18n.implement_images }}</h5>
                                                <p class="card-text m-0">{{ g.i18n.implement_images_description }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container py-5">
        <div class="row">
            <div class="col-lg-6">
                <div class="position-sticky" style="top: 50px">
                    <h2 class="page-header mb-3 fw-semibold lh-1">{{ g.i18n.faq_title }}</h2>
                    <p>{{ g.i18n.faq_meta_description }}</p>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="bsb-timeline-1 pt-5 pt-xl-8 ms-2">
                    <ul class="timeline">
                        {% for faq in faqs %}
                            <li class="timeline-item">
                                <div class="timeline-body">
                                    <div class="timeline-content">
                                        <div class="card border-0">
                                            <div class="card-body p-0">
                                                <h5 class="card-subtitle mb-1 fw-bold">{{ faq.question }}</h5>
                                                <p class="card-text m-0">{{ faq.value }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    <script>
        (function () {
            "use strict";
            $(document).ready(
                function () {
                    var container = $(".page-container");
                    var zipUrl;

                    container.on("submit", "#websiteForm", onSubmitWebsiteForm);
                    container.on("click", "#processImages", onProcessImages);
                    container.on("click", "#downloadImages", onDownloadImages);
                    container.on("click", ".remove-item", onRemoveItem);

                    function onDownloadImages(e) {
                        if (zipUrl) {
                            window.open(zipUrl, '_blank');
                            return
                        }

                        e.preventDefault();

                        var downloadButton = container.find("#downloadImages");

                        downloadButton.prop("disabled", true);
                        downloadButton.find(".spinner-border").removeClass("d-none");

                        var uuidsList = container.find("a[data-uuid]").map(function () {
                            return $(this).attr("data-uuid");
                        }).get();

                        $.ajax({
                            url: "{{ g.api_domain }}/zip",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify({
                                uuids: uuidsList
                            }),
                            success: function (response) {
                                zipUrl = response.zip_url;
                                window.open(zipUrl, '_blank');
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                alert("Error: " + textStatus + ": " + errorThrown);
                            },
                            complete: function () {
                                downloadButton.prop("disabled", false);
                                downloadButton.find(".spinner-border").addClass("d-none");
                            }
                        });
                    }

                    function onRemoveItem(e) {
                        e.preventDefault();
                        $(this).closest("[data-url]").remove();

                        if (container.find("#listImages div[data-url]").length === 0) {
                            container.find("#listImages").html("");
                        }
                    }

                    function onProcessImages() {
                        container.find("#actionConvertWrapper").hide();
                        $('html, body').animate({
                            scrollTop: container.find("#listImages").offset().top
                        });

                        var images = container.find(".images-found div[data-url]");
                        processImagesSequentially(images);
                    }

                    function processImagesSequentially(images) {
                        if (images.length === 0) {
                            console.log("All images have been processed.");
                            container.find("#actionDownloadWrapper").show();
                            return;
                        }

                        var currentImage = images.first();
                        var imageUrl = currentImage.data("url");
                        var resultDiv = currentImage.find(".result");
                        var convertTo = container.find('input[name="format"]:checked').val();

                        resultDiv.html(`<div class="spinner-border text-primary" role="status"> <span class="sr-only d-none">{{ g.i18n.loading }}...</span></div>`);

                        $.ajax({
                            url: "{% url "url-optimizer" %}",
                            type: "POST",
                            headers: {
                                "X-CSRFToken": window.csrf_token
                            },
                            data: {
                                url: imageUrl,
                                format: convertTo
                            },
                            success: function (response) {
                                resultDiv.html(response.html);
                                currentImage.removeAttr("data-url");

                                processImagesSequentially(images.slice(1));
                            },
                            error: function () {
                                resultDiv.html(`<span class="text-danger">{{ g.i18n.error }}</span>`);
                                currentImage.removeAttr("data-url");

                                processImagesSequentially(images.slice(1));
                            }
                        });
                    }

                    function onSubmitWebsiteForm(e) {
                        zipUrl = null;
                        e.preventDefault();
                        var target = $(this);
                        var submitButton = target.find("#submitButton");

                        submitButton.prop("disabled", true);
                        submitButton.find(".spinner-border").removeClass("d-none");

                        $.ajax({
                            url: "{% url 'web-extractor' %}",
                            type: "POST",
                            data: $(this).serialize(),
                            success: function (response) {
                                container.find("#listImages").html(response.html);
                                $('html, body').animate({
                                    scrollTop: container.find("#listImages").offset().top + container.find("#listImages")[0].scrollHeight - 400
                                });
                            },
                            error: function (jqXHR, textStatus, errorThrown) {
                                var errorMessage = "Error: " + textStatus + ": " + errorThrown;

                                if (jqXHR.responseJSON && jqXHR.responseJSON.error) {
                                    errorMessage = "Error: " + jqXHR.responseJSON.error;
                                }

                                alert(errorMessage);
                            },
                            complete: function () {
                                submitButton.prop("disabled", false);
                                submitButton.find(".spinner-border").addClass("d-none");
                            }
                        });
                    }
                }
            );
        }());
    </script>
{% endblock %}